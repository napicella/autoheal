#!/usr/bin/env bash
# --------------------------------------------------------------------
# This script clones the Autoheal repository and builds a Docker
# container using the provided multi-stage Dockerfile for the Go project.
#
# Usage:
#   ./install [image_name:tag] [go_version]
#   Defaults:
#       image_name: autoheal:latest
#       go_version: 1.25
# --------------------------------------------------------------------
set -euo pipefail

# Defaults
IMAGE_NAME="${1:-autoheal:latest}"
GO_VERSION="${2:-1.25}"
REPO_URL="https://github.com/napicella/autoheal.git"
REPO_DIR="./autoheal"
DOCKERFILE_PATH="$REPO_DIR/Dockerfile"

if [ ! -d "$REPO_DIR" ]; then
    echo "üì• Cloning Autoheal repository..."
    git clone "$REPO_URL" "$REPO_DIR"
else
    echo "üìÇ Repository already exists at $REPO_DIR, pulling latest changes..."
    git -C "$REPO_DIR" pull
fi

echo "============================================"
echo "‚öôÔ∏è  Autoheal Docker Install"
echo "--------------------------------------------"
echo "This will build the Docker image for autoheal."
echo "Image name: $IMAGE_NAME"
echo "Go version:  $GO_VERSION"
echo
read -p "Proceed with building the image? [y/N]: " CONFIRM < /dev/tty
if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "‚ùå Installation aborted."
    exit 1
fi

echo
echo "üì¶ Building Docker image '$IMAGE_NAME' with Go $GO_VERSION..."
echo "--------------------------------------------"

# Step 2: Build the Docker image
docker build \
    --build-arg GOVERSION="$GO_VERSION" \
    -t "$IMAGE_NAME" \
    -f "$DOCKERFILE_PATH" .

echo
echo "‚úÖ Docker image '$IMAGE_NAME' built successfully!"
echo "You can now run autoheal with:"
echo "docker run -v /var/run/docker.sock:/var/run/docker.sock $IMAGE_NAME -project myproject -verbose"
echo
echo "üìñ For more information, please check the README:"
echo "https://github.com/napicella/autoheal"
echo "============================================"
